name: Commit Reminder & README Bot

on:
  schedule:
    - cron: '50 20 * * *'  # 11:50 PM EAT (UTC+3) = 8:50 PM UTC
  workflow_dispatch:       # Allow manual run from GitHub UI

jobs:
  check-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check for commits today (UTC)
        id: commitcheck
        run: |
          TODAY=$(date -u +%F)
          COMMITS=$(git log --since=$TODAY --oneline | wc -l)
          echo "Today's commits: $COMMITS"
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT

      - name: Send WhatsApp reminder if no commits
        if: steps.commitcheck.outputs.commits == '0'
        run: |
          echo "📲 Sending WhatsApp reminder via Twilio..."
          curl -X POST https://api.twilio.com/2010-04-01/Accounts/${{ secrets.TWILIO_ACCOUNT_SID }}/Messages.json \
          --data-urlencode "To=whatsapp:+254768133220" \
          --data-urlencode "From=whatsapp:+14155238886" \
          --data-urlencode "Body=🚨 No commits today! Push something or the bot will change your README." \
          -u "${{ secrets.TWILIO_ACCOUNT_SID }}:${{ secrets.TWILIO_AUTH_TOKEN }}" -v

      - name: Force README push if no commit
        if: steps.commitcheck.outputs.commits == '0'
        run: |
          echo "🔁 Automated reminder at $(date)" >> README.md
          git config user.email "bot@github.com"
          git config user.name "ReminderBot"
          git add README.md
          git commit -m "🤖 Auto update README: No commit on $(date -I)"
          git remote set-url origin https://x-access-token:${{ secrets.PAT }}@github.com/${{ github.repository }}
          git push origin HEAD:main
