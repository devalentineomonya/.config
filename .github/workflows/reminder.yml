name: Commit Reminder & Log Bot

on:
  schedule:
    - cron: '50 20 * * *'  # 11:50 PM EAT (UTC+3)
  workflow_dispatch:

jobs:
  check-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check for commits today (UTC)
        id: commitcheck
        run: |
          TODAY=$(date -u +%F)
          COMMITS=$(git log --since=$TODAY --oneline | wc -l)
          echo "Today's commits: $COMMITS"
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT

      - name: Send WhatsApp roast if no commits
        if: steps.commitcheck.outputs.commits == '0'
        run: |
          ROAST=$(shuf -n 1 .roasts.txt)
          echo "ğŸ”¥ Chosen roast: $ROAST"
          curl -X POST https://api.twilio.com/2010-04-01/Accounts/${{ secrets.TWILIO_ACCOUNT_SID }}/Messages.json \
          --data-urlencode "To=whatsapp:+254768133220" \
          --data-urlencode "From=whatsapp:+14155238886" \
          --data-urlencode "Body=$ROAST" \
          -u "${{ secrets.TWILIO_ACCOUNT_SID }}:${{ secrets.TWILIO_AUTH_TOKEN }}"

      - name: Debug Token Info (Safe)
        run: |
          echo "Repo: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"
          echo "Token length: ${#{{ secrets.PAT }}}"

      - name: Log commit inactivity
        if: steps.commitcheck.outputs.commits == '0'
        run: |
          mkdir -p .log
          echo "ğŸ“… No commit on $(date -u) â€” reminder triggered." >> .log/commit-check.log
          git config user.email "bot@github.com"
          git config user.name "ReminderBot"
          git add .log/commit-check.log
          git commit -m "ğŸ“ Log: No commit on $(date -I)"
          git remote set-url origin https://x-access-token:${{ secrets.PAT }}@github.com/${{ github.repository }}
          git push origin HEAD:main
